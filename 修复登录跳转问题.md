# 修复登录后立即跳转回登录页问题

## 问题分析

登录成功后跳转到dashboard，但立即又跳转回login页。

**可能的原因**：
1. Dashboard加载时API请求返回422错误
2. 422错误触发拦截器清除token
3. token被清除后，App.js检测到未认证，重定向到登录页

## 已实施的修复

### 1. 优化422错误处理
- 只有明确的token错误才清除token
- 其他422错误（业务逻辑错误）不自动跳转登录

### 2. 添加调试日志
- 在App.js中添加认证状态检查日志
- 在API拦截器中添加错误日志

### 3. 增强登录逻辑
- 确保token正确保存
- 验证token是否已保存才跳转

## 排查步骤

### 步骤1: 查看浏览器控制台

在浏览器中：
1. 按 F12 打开开发者工具
2. 切换到 Console（控制台）标签
3. 尝试登录
4. 查看日志输出：
   - "检查认证状态: 已认证/未认证"
   - "收到authChange事件"
   - "收到422错误: ..."
   - "JWT验证失败，清除token: ..."

### 步骤2: 查看Network请求

1. 切换到 Network（网络）标签
2. 尝试登录
3. 查看跳转到dashboard后的API请求：
   - `/api/reports/dashboard` - 状态码是什么？
   - `/api/projects` - 状态码是什么？
   - 如果返回422，响应内容是什么？

### 步骤3: 检查token

在浏览器Console中执行：

```javascript
// 检查token
localStorage.getItem('token')

// 应该返回一个JWT token字符串
// 如果返回null，说明token没有保存
```

## 如果422错误持续

如果看到422错误且不是token错误，可能是：

### 原因1: 后端API返回422（业务逻辑错误）

检查后端日志：
```bash
docker-compose logs --tail=50 backend
```

查看具体的错误信息。

### 原因2: Token格式问题

检查token是否正确：
```javascript
// 在浏览器Console中
const token = localStorage.getItem('token');
console.log('Token:', token);
console.log('Token长度:', token?.length);
```

### 原因3: 后端JWT配置问题

检查后端JWT配置：
```bash
docker-compose exec backend python -c "
from app import app
print('JWT_SECRET_KEY:', app.config.get('JWT_SECRET_KEY')[:20] + '...')
"
```

## 临时解决方案

如果问题持续，可以临时禁用自动跳转：

```javascript
// 在api.js中，临时注释掉422错误的自动跳转
// window.location.href = '/login';
```

但这只是临时方案，需要找到根本原因。

## 验证修复

1. **清除浏览器缓存和localStorage**
   - 打开F12 -> Application -> Local Storage
   - 清除所有内容

2. **重新登录**
   - 使用 admin/admin123
   - 观察Console日志

3. **检查是否跳转**
   - 应该停留在dashboard
   - Console中应该显示"已认证"

