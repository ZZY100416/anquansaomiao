# 快速修复创建项目失败

## 问题现象

点击"新建项目"后显示"创建失败"错误。

## 立即排查（在Ubuntu上执行）

### 步骤1: 查看后端日志（最重要）

```bash
# 查看后端最近日志
docker-compose logs --tail=50 backend

# 实时查看日志
docker-compose logs -f backend
```

**关键检查点**：
- 是否有错误信息？
- 是否有数据库连接错误？
- 是否有API请求记录？

### 步骤2: 测试创建项目API

```bash
# 先获取token（需要先登录）
# 在浏览器中登录后，打开F12开发者工具 -> Application -> Local Storage
# 找到token值，然后执行：

TOKEN="你的token值"

# 测试创建项目API
curl -X POST http://localhost:5000/api/projects \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "name": "测试项目",
    "description": "测试描述",
    "repository_url": "https://github.com/test/repo.git",
    "project_type": "java"
  }' \
  -v
```

### 步骤3: 检查浏览器控制台

在浏览器中：
1. 按 F12 打开开发者工具
2. 切换到 Console（控制台）标签
3. 查看是否有错误信息
4. 切换到 Network（网络）标签
5. 尝试创建项目，查看 `/api/projects` 请求：
   - 状态码是什么？
   - 请求URL是否正确？
   - 响应内容是什么？

### 步骤4: 检查数据库连接

```bash
# 检查数据库是否正常
docker-compose exec backend python -c "
from app import app, db
with app.app_context():
    try:
        db.session.execute('SELECT 1')
        print('✓ 数据库连接正常')
    except Exception as e:
        print(f'✗ 数据库连接失败: {e}')
"
```

## 常见问题及解决方案

### 问题1: 认证失败（401 Unauthorized）

**症状**：后端日志显示401错误

**解决**：
```bash
# 检查token是否有效
# 在浏览器中重新登录，确保token已保存

# 或者检查前端是否正确发送token
# 在浏览器Network标签中查看请求头是否有Authorization字段
```

### 问题2: 数据库连接失败

**症状**：后端日志显示数据库连接错误

**解决**：
```bash
# 检查PostgreSQL是否运行
docker-compose ps postgres

# 重启数据库
docker-compose restart postgres

# 等待数据库启动
sleep 10

# 重启后端
docker-compose restart backend
```

### 问题3: 字段验证失败

**症状**：后端返回400错误，提示字段错误

**检查**：
- 项目名称是否为空？
- 项目类型是否正确？
- 必填字段是否都已填写？

### 问题4: CORS错误

**症状**：浏览器控制台显示CORS错误

**解决**：后端已配置CORS，如果还有问题：
```bash
# 检查后端CORS配置
docker-compose logs backend | grep -i cors
```

## 快速诊断脚本

```bash
#!/bin/bash
cd ~/projects/anquansaomiao

echo "=== 1. 检查容器状态 ==="
docker-compose ps

echo ""
echo "=== 2. 检查数据库连接 ==="
docker-compose exec backend python -c "
from app import app, db
with app.app_context():
    try:
        db.session.execute('SELECT 1')
        print('✓ 数据库连接正常')
    except Exception as e:
        print(f'✗ 数据库连接失败: {e}')
"

echo ""
echo "=== 3. 查看后端最近日志 ==="
docker-compose logs --tail=20 backend | tail -20

echo ""
echo "=== 4. 测试API健康检查 ==="
curl -s http://localhost:5000/api/health | head -5

echo ""
echo "=== 诊断完成 ==="
```

## 如果还是不行

请提供以下信息：

1. **后端日志**：
   ```bash
   docker-compose logs --tail=50 backend
   ```

2. **浏览器控制台错误**：
   - 打开F12 -> Console标签
   - 复制错误信息

3. **Network请求详情**：
   - 打开F12 -> Network标签
   - 尝试创建项目
   - 查看 `/api/projects` 请求的详细信息

