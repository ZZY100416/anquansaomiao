name: Docker Security Scan

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'docker-compose.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'

jobs:
  dockerfile-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
          failure-threshold: warning
      
      - name: Run Hadolint on Frontend
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: frontend/Dockerfile
          failure-threshold: warning

  container-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build backend image
        run: |
          docker build -t backend-test ./backend
      
      - name: Build frontend image
        run: |
          docker build -t frontend-test ./frontend
      
      - name: Run Trivy scan on backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: backend-test
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
      
      - name: Run Trivy scan on frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: frontend-test
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

