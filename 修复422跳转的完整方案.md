# 修复422跳转的完整方案

## 问题确认

从Network标签看到：
- `/api/reports/dashboard` 请求返回 **422错误**
- 后端 `invalid_token_loader` 在token无效时返回422，错误信息：`"无效的Token: ..."`

## 可能的原因

1. **Token格式问题**：Token可能不完整或格式错误
2. **JWT Secret不匹配**：后端重启后JWT secret可能改变
3. **Token未正确发送**：虽然前端添加了Authorization头，但可能有问题

## 立即排查步骤

### 在浏览器中：

1. **打开Network标签**
2. **找到 `/api/reports/dashboard` 请求（422错误）**
3. **点击该请求 -> Headers标签**：
   - 查看Request Headers中的 `Authorization` 字段
   - 应该看到：`Authorization: Bearer <token>`
   - 复制完整的token值

4. **点击Response标签**：
   - 查看完整的错误响应
   - 应该类似：`{"error": "无效的Token: ..."}`

5. **在Console中执行**：
   ```javascript
   // 检查token
   const token = localStorage.getItem('token');
   console.log('Token:', token);
   console.log('Token长度:', token?.length);
   console.log('Token是否以Bearer开头:', token?.startsWith('Bearer'));
   ```

### 在Ubuntu上：

```bash
# 查看后端日志，看具体的422错误
docker-compose logs --tail=100 backend | grep -i "422\|dashboard\|jwt\|token\|invalid"

# 查看后端JWT配置
docker-compose exec backend python -c "from app import app; print('JWT_SECRET_KEY:', app.config.get('JWT_SECRET_KEY'))"
```

## 临时解决方案

如果需要快速验证，可以临时禁用422的自动跳转：

但这不是根本解决方案。

## 根本解决方案

需要根据排查结果确定：
- 如果是Token格式问题：修复登录时的token保存
- 如果是JWT Secret不匹配：统一后端和登录时的secret
- 如果是Token未发送：检查请求拦截器

## 已添加的调试信息

前端现在会：
1. 在发送dashboard请求时，打印token信息
2. 收到422错误时，打印完整的错误信息
3. 只在明确是token错误时才清除token并跳转

请提供：
1. Network中dashboard请求的Headers（Authorization字段）
2. Network中dashboard请求的Response内容
3. Console中的"收到422错误"日志

