# 修复频繁跳转登录页问题

## 问题分析

登录成功后跳转到dashboard，但立即又跳转回login页。

**根本原因**：
1. Dashboard加载时调用 `/api/reports/dashboard`
2. API返回422错误（JWT验证失败）
3. 422错误被误判为token错误，清除token
4. token被清除后，App.js检测到未认证，重定向到登录页

## 已实施的修复

### 1. 优化422错误判断逻辑
- 更严格的token错误判断
- 添加调试日志，查看完整错误信息
- 延迟跳转，避免冲突

### 2. 优化认证状态检查
- 延迟检查，确保localStorage已更新
- 添加详细日志

### 3. 优化API错误处理
- Dashboard等页面API错误不导致跳转
- 设置默认数据，避免页面报错

## 立即排查（在浏览器中）

### 步骤1: 查看Console日志

1. 打开F12开发者工具 -> Console标签
2. 尝试登录
3. 查看日志：
   - "收到422错误: ..."
   - "JWT验证失败，清除token: ..." 或 "422错误（非token错误，不跳转）: ..."
   - "认证状态变化: ..."

### 步骤2: 查看Network请求

1. 切换到Network标签
2. 尝试登录
3. 查看跳转到dashboard后的请求：
   - `/api/reports/dashboard` - 状态码和响应内容
   - 如果返回422，查看Response标签的完整内容

### 步骤3: 检查token

在Console中执行：

```javascript
// 检查token
localStorage.getItem('token')

// 应该返回一个JWT token字符串
```

## 如果还是频繁跳转

### 临时解决方案：禁用422自动跳转

如果问题持续，可以临时禁用422错误的自动跳转：

```javascript
// 在api.js中，临时注释掉window.location.href = '/login';
// 但这不是根本解决方案
```

### 根本解决方案：检查后端JWT配置

可能后端JWT验证有问题，检查：

```bash
# 在Ubuntu上
docker-compose logs backend | grep -i "422\|jwt\|token"
```

## 验证修复

1. **清除浏览器缓存**
   - F12 -> Application -> Local Storage -> 清除

2. **重新登录**
   - 使用 admin/admin123
   - 观察Console日志

3. **检查是否跳转**
   - 应该停留在dashboard
   - Console中应该显示"已认证"
   - 如果有422错误，应该显示"422错误（非token错误，不跳转）"

