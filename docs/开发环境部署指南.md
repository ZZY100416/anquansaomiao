# 开发环境部署指南

## 目录

1. [Ubuntu虚拟机环境搭建](#ubuntu虚拟机环境搭建)
2. [本地开发环境配置](#本地开发环境配置)
3. [Docker开发环境](#docker开发环境)
4. [IDE配置](#ide配置)
5. [调试配置](#调试配置)
6. [常见问题](#常见问题)

## Ubuntu虚拟机环境搭建

### 1. 创建Ubuntu虚拟机

#### 使用VirtualBox

1. 下载Ubuntu 20.04 LTS ISO镜像
2. 创建新虚拟机：
   - 名称: DevSecOps-Dev
   - 类型: Linux
   - 版本: Ubuntu (64-bit)
   - 内存: 至少4GB
   - 硬盘: 至少30GB
3. 安装Ubuntu系统

#### 使用VMware

1. 下载Ubuntu 20.04 LTS ISO镜像
2. 创建新虚拟机，配置同上

### 2. 系统初始化配置

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y \
    git \
    curl \
    wget \
    vim \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release

# 设置时区
sudo timedatectl set-timezone Asia/Shanghai

# 配置SSH（如果需要远程访问）
sudo apt install -y openssh-server
sudo systemctl enable ssh
sudo systemctl start ssh
```

### 3. 安装Docker

```bash
# 添加Docker官方GPG密钥
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 设置仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户添加到docker组
sudo usermod -aG docker $USER

# 验证安装
docker --version
docker compose version

# 注意：添加用户到docker组后，需要重新登录才能生效
# 或者使用：newgrp docker
```

### 4. 安装Git和配置SSH

```bash
# 安装Git
sudo apt install -y git

# 配置Git用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 配置Git默认分支名
git config --global init.defaultBranch main

# 生成SSH密钥
ssh-keygen -t ed25519 -C "your.email@example.com"
# 按回车使用默认路径
# 设置密码（可选）

# 查看公钥
cat ~/.ssh/id_ed25519.pub

# 将公钥添加到GitHub
# 1. 复制公钥内容
# 2. 访问 https://github.com/settings/keys
# 3. 点击 "New SSH key"
# 4. 粘贴公钥并保存

# 测试SSH连接
ssh -T git@github.com
```

### 5. 安装Python开发环境

```bash
# 安装Python 3.11
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip

# 安装pip工具
sudo apt install -y python3-pip

# 升级pip
pip3 install --upgrade pip

# 安装常用Python包管理工具
pip3 install virtualenv virtualenvwrapper

# 配置virtualenvwrapper（可选）
echo 'export WORKON_HOME=$HOME/.virtualenvs' >> ~/.bashrc
echo 'source /usr/local/bin/virtualenvwrapper.sh' >> ~/.bashrc
source ~/.bashrc
```

### 6. 安装Node.js开发环境

```bash
# 安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version
npm --version

# 安装yarn（可选）
npm install -g yarn

# 安装常用全局工具
npm install -g nodemon pm2
```

### 7. 克隆项目

```bash
# 创建项目目录
mkdir -p ~/projects
cd ~/projects

# 克隆项目（如果已创建GitHub仓库）
git clone git@github.com:your-org/unified-security-scanner.git
cd unified-security-scanner

# 或者初始化新仓库
git init
git remote add origin git@github.com:your-org/unified-security-scanner.git
```

## 本地开发环境配置

### 后端开发环境

```bash
# 进入后端目录
cd backend

# 创建Python虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 升级pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt

# 安装开发依赖
pip install pytest pytest-cov black flake8 mypy

# 创建环境变量文件
cp .env.example .env
# 编辑.env文件，配置数据库连接等

# 初始化数据库
python init_db.py

# 运行开发服务器
python app.py
```

### 前端开发环境

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 创建环境变量文件
cp .env.example .env.local
# 编辑.env.local，配置API地址

# 启动开发服务器
npm start
```

### 数据库配置

```bash
# 使用Docker运行PostgreSQL（推荐）
docker run -d \
  --name postgres-dev \
  -e POSTGRES_DB=security_scanner \
  -e POSTGRES_USER=scanner \
  -e POSTGRES_PASSWORD=scanner123 \
  -p 5432:5432 \
  postgres:15-alpine

# 或使用本地PostgreSQL
sudo apt install -y postgresql postgresql-contrib
sudo -u postgres createdb security_scanner
sudo -u postgres createuser scanner
sudo -u postgres psql -c "ALTER USER scanner WITH PASSWORD 'scanner123';"
```

## Docker开发环境

### 使用Docker Compose开发

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 停止服务
docker-compose stop

# 停止并删除容器
docker-compose down

# 重建服务（代码更新后）
docker-compose up -d --build

# 进入容器
docker-compose exec backend bash
docker-compose exec frontend sh
```

### 开发模式配置

创建 `docker-compose.dev.yml`:

```yaml
version: '3.8'

services:
  backend:
    volumes:
      - ./backend:/app
      - /app/venv  # 排除venv目录
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    command: python app.py

  frontend:
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_URL=http://localhost:5000/api
      - CHOKIDAR_USEPOLLING=true  # 文件监听
```

使用开发配置：

```bash
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
```

## IDE配置

### VS Code配置

#### 安装推荐扩展

```json
{
  "recommendations": [
    "ms-python.python",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "ms-azuretools.vscode-docker",
    "eamodio.gitlens",
    "ms-vscode.remote-containers",
    "ms-vscode-remote.remote-wsl"
  ]
}
```

#### 工作区配置 `.vscode/settings.json`

```json
{
  "python.defaultInterpreterPath": "${workspaceFolder}/backend/venv/bin/python",
  "python.formatting.provider": "black",
  "python.linting.enabled": true,
  "python.linting.pylintEnabled": false,
  "python.linting.flake8Enabled": true,
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  },
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    "**/node_modules": true
  },
  "[python]": {
    "editor.defaultFormatter": "ms-python.black-formatter",
    "editor.tabSize": 4
  },
  "[javascript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.tabSize": 2
  },
  "[json]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

#### 调试配置 `.vscode/launch.json`

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python: Flask",
      "type": "python",
      "request": "launch",
      "program": "${workspaceFolder}/backend/app.py",
      "console": "integratedTerminal",
      "env": {
        "FLASK_ENV": "development",
        "FLASK_DEBUG": "1"
      },
      "jinja": true
    },
    {
      "name": "Python: Current File",
      "type": "python",
      "request": "launch",
      "program": "${file}",
      "console": "integratedTerminal"
    }
  ]
}
```

### PyCharm配置

1. 打开项目
2. 配置Python解释器：
   - File → Settings → Project → Python Interpreter
   - 选择 `backend/venv/bin/python`
3. 配置运行配置：
   - Run → Edit Configurations
   - 添加Flask配置
   - Script path: `backend/app.py`
   - Environment variables: `FLASK_ENV=development`

## 调试配置

### 后端调试

#### 使用VS Code调试

1. 设置断点
2. 按F5启动调试
3. 在浏览器中访问API触发断点

#### 使用pdb调试

```python
# 在代码中添加
import pdb; pdb.set_trace()

# 或使用
breakpoint()  # Python 3.7+
```

### 前端调试

#### React DevTools

1. 安装浏览器扩展
2. 在开发者工具中查看React组件树
3. 检查组件状态和Props

#### 使用console调试

```javascript
// 在代码中添加
console.log('Debug info:', data);
console.table(arrayData);
debugger;  // 断点
```

### Docker容器调试

```bash
# 进入运行中的容器
docker-compose exec backend bash

# 在容器中调试
docker-compose exec backend python -m pdb app.py

# 查看容器日志
docker-compose logs -f --tail=100 backend
```

## 常见问题

### Q1: Docker权限问题

**错误**: `permission denied while trying to connect to the Docker daemon socket`

**解决方案**:

```bash
# 将用户添加到docker组
sudo usermod -aG docker $USER

# 重新登录或执行
newgrp docker

# 验证
docker ps
```

### Q2: 端口被占用

**错误**: `Error: bind: address already in use`

**解决方案**:

```bash
# 查找占用端口的进程
sudo lsof -i :3000
sudo lsof -i :5000

# 杀死进程
sudo kill -9 <PID>

# 或修改docker-compose.yml中的端口映射
```

### Q3: 前端无法连接后端

**错误**: `Network Error` 或 `CORS error`

**解决方案**:

1. 检查后端服务是否运行
2. 检查API地址配置
3. 检查CORS配置
4. 检查防火墙设置

### Q4: 数据库连接失败

**错误**: `could not connect to server`

**解决方案**:

```bash
# 检查PostgreSQL容器状态
docker-compose ps postgres

# 检查数据库配置
cat backend/.env

# 测试连接
docker-compose exec backend python -c "from app import db; db.create_all()"
```

### Q5: Python依赖安装失败

**错误**: `Failed building wheel`

**解决方案**:

```bash
# 安装编译依赖
sudo apt install -y python3-dev build-essential

# 升级pip和工具
pip install --upgrade pip setuptools wheel

# 重新安装
pip install -r requirements.txt
```

### Q6: Node模块安装失败

**错误**: `npm ERR!` 或权限错误

**解决方案**:

```bash
# 清除npm缓存
npm cache clean --force

# 删除node_modules和package-lock.json
rm -rf node_modules package-lock.json

# 重新安装
npm install

# 如果仍有问题，使用sudo（不推荐）
sudo npm install
```

### Q7: Git推送失败

**错误**: `Permission denied (publickey)`

**解决方案**:

```bash
# 检查SSH密钥
ls -la ~/.ssh/

# 测试SSH连接
ssh -T git@github.com

# 如果失败，重新添加SSH密钥到ssh-agent
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519

# 确认公钥已添加到GitHub
```

### Q8: 虚拟环境问题

**错误**: `ModuleNotFoundError`

**解决方案**:

```bash
# 确认虚拟环境已激活
which python  # 应该显示venv路径

# 重新创建虚拟环境
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## 开发工具推荐

### 后端开发

- **代码格式化**: black
- **代码检查**: flake8, pylint
- **类型检查**: mypy
- **测试框架**: pytest
- **API测试**: Postman, Insomnia

### 前端开发

- **代码格式化**: Prettier
- **代码检查**: ESLint
- **包管理**: npm 或 yarn
- **构建工具**: Create React App (已内置)

### 通用工具

- **版本控制**: Git
- **容器管理**: Docker, Docker Compose
- **文本编辑器**: VS Code, Vim
- **数据库管理**: DBeaver, pgAdmin
- **API文档**: Swagger UI

## 下一步

1. 阅读 [团队分工与Git工作流](团队分工与Git工作流.md)
2. 阅读 [代码提交规范](团队分工与Git工作流.md#代码提交规范)
3. 开始开发功能模块
4. 参与代码审查

## 技术支持

如遇到问题：

1. 查看本文档的常见问题部分
2. 查看项目GitHub Issues
3. 联系团队技术支持

