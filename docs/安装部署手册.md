# 统一安全扫描平台 - 安装部署手册

## 目录

1. [系统要求](#系统要求)
2. [快速部署](#快速部署)
3. [详细配置](#详细配置)
4. [验证安装](#验证安装)
5. [常见问题](#常见问题)

## 系统要求

### 硬件要求

- **CPU**: 2核以上
- **内存**: 4GB以上（推荐8GB）
- **磁盘**: 20GB以上可用空间
- **网络**: 需要访问互联网以下载依赖和扫描规则

### 软件要求

- **操作系统**: Linux (Ubuntu 20.04+ / CentOS 7+), macOS, Windows (WSL2)
- **Docker**: 20.10或更高版本
- **Docker Compose**: 2.0或更高版本

### 验证环境

```bash
# 检查Docker版本
docker --version

# 检查Docker Compose版本
docker-compose --version

# 检查Docker服务状态
docker info
```

## 快速部署

### 1. 克隆项目

```bash
git clone <repository-url>
cd unified-security-scanner
```

### 2. 配置环境变量（可选）

创建 `.env` 文件（可选，使用默认值）：

```bash
# 数据库配置
POSTGRES_DB=security_scanner
POSTGRES_USER=scanner
POSTGRES_PASSWORD=scanner123

# 应用密钥（生产环境请修改）
SECRET_KEY=your-secret-key-change-in-production

# API地址
REACT_APP_API_URL=http://localhost:5000/api
```

### 3. 启动服务

```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4. 初始化数据库

首次启动后，后端服务会自动创建数据库表。如果需要创建默认管理员账户，可以执行：

```bash
# 进入后端容器
docker-compose exec backend bash

# 运行初始化脚本
python init_db.py
```

### 5. 访问应用

- **Web界面**: http://localhost:3000
- **API文档**: http://localhost:5000/api/health
- **默认账号**: admin / admin123

## 详细配置

### 端口配置

默认端口配置：

- **前端**: 3000
- **后端API**: 5000
- **PostgreSQL**: 5432
- **Redis**: 6379

如需修改端口，编辑 `docker-compose.yml`：

```yaml
services:
  frontend:
    ports:
      - "8080:3000"  # 将前端端口改为8080
```

### 数据库配置

#### PostgreSQL持久化

数据库数据存储在Docker卷中，即使容器删除数据也不会丢失：

```bash
# 查看数据卷
docker volume ls

# 备份数据库
docker-compose exec postgres pg_dump -U scanner security_scanner > backup.sql

# 恢复数据库
docker-compose exec -T postgres psql -U scanner security_scanner < backup.sql
```

#### 外部数据库

如需使用外部PostgreSQL数据库，修改 `docker-compose.yml`：

```yaml
services:
  backend:
    environment:
      - DATABASE_URL=postgresql://user:password@host:5432/dbname
    # 移除 depends_on postgres
```

### 扫描器配置

#### Semgrep规则

Semgrep使用默认规则集。如需自定义规则：

1. 创建规则目录：`backend/rules/`
2. 在扫描配置中指定规则路径

#### Trivy配置

Trivy会自动下载漏洞数据库。首次运行可能需要较长时间。

#### Dependency-Check配置

Dependency-Check数据存储在容器内，首次运行会自动下载NVD数据库。

### 存储配置

扫描结果和上传文件存储在Docker卷中：

- `scan_results`: 扫描结果文件
- `uploaded_files`: 上传的项目文件

## 验证安装

### 1. 检查服务状态

```bash
docker-compose ps
```

所有服务应显示为 `Up` 状态。

### 2. 检查API健康

```bash
curl http://localhost:5000/api/health
```

应返回：`{"status": "healthy", "service": "Unified Security Scanner API"}`

### 3. 测试登录

访问 http://localhost:3000，使用默认账号登录。

### 4. 测试扫描功能

1. 创建测试项目
2. 创建扫描任务
3. 查看扫描结果

## 常见问题

### 问题1: 端口被占用

**错误**: `Error: bind: address already in use`

**解决方案**:

```bash
# 查看占用端口的进程
sudo lsof -i :3000
sudo lsof -i :5000

# 修改docker-compose.yml中的端口映射
```

### 问题2: 数据库连接失败

**错误**: `could not connect to server`

**解决方案**:

1. 检查PostgreSQL容器是否运行：`docker-compose ps postgres`
2. 检查数据库配置是否正确
3. 查看后端日志：`docker-compose logs backend`

### 问题3: 前端无法连接后端

**错误**: `Network Error` 或 `CORS error`

**解决方案**:

1. 检查后端服务是否运行：`docker-compose ps backend`
2. 检查 `REACT_APP_API_URL` 配置
3. 确认防火墙设置

### 问题4: 扫描器执行失败

**错误**: `扫描失败` 或 `命令未找到`

**解决方案**:

1. 检查扫描器是否已安装：进入后端容器执行 `semgrep --version`
2. 检查项目路径是否正确
3. 查看详细日志：`docker-compose logs backend`

### 问题5: 内存不足

**错误**: 容器频繁重启或OOM

**解决方案**:

1. 增加Docker内存限制
2. 减少并发扫描任务
3. 优化扫描配置

### 问题6: 初始化管理员账户

如果默认账户不存在，可以手动创建：

```bash
docker-compose exec backend python
```

```python
from app import app, db
from app.models.user import User

with app.app_context():
    admin = User(username='admin', email='admin@example.com', role='admin')
    admin.set_password('admin123')
    db.session.add(admin)
    db.session.commit()
    print('管理员账户创建成功')
```

## 升级部署

### 更新代码

```bash
# 拉取最新代码
git pull

# 重建并重启服务
docker-compose up -d --build
```

### 数据迁移

如果数据库结构有变化，需要执行迁移：

```bash
docker-compose exec backend python migrate.py
```

## 卸载

```bash
# 停止并删除容器
docker-compose down

# 删除数据卷（谨慎操作，会删除所有数据）
docker-compose down -v
```

## 生产环境建议

1. **修改默认密码**: 立即修改默认管理员密码
2. **使用HTTPS**: 配置反向代理（Nginx）启用HTTPS
3. **数据备份**: 定期备份PostgreSQL数据库
4. **监控告警**: 配置日志监控和告警
5. **资源限制**: 为容器设置CPU和内存限制
6. **安全加固**: 定期更新Docker镜像和依赖

## 技术支持

如遇到问题，请查看：

- [GitHub Issues](repository-url/issues)
- [用户手册](用户使用手册.md)
- [API文档](API接口文档.md)

