# 统一安全扫描平台运维排障手册

> 本手册沉淀了部署、运行、OpenRASP 集成、数据库连接等全部问题解决经验，供运维、安全平台工程师快速定位问题。

## 1. 使用说明

- 每个条目遵循“现象 → 原因 → 解决步骤 → 验证”格式。
- 涉及的脚本或命令可在仓库 `docs/` 下找到对应 Markdown。
- 若遇到未覆盖问题，可在结尾记录处补充。

## 2. 构建与部署问题

### 2.1 Dependency-Check 下载失败

- **现象**：`docker-compose build backend` 卡住或报错 `dependency-check ... failed`。
- **原因**：GitHub 网络不稳或版本号失效。
- **解决步骤**：
  1. Dockerfile 已加入重试与备用版本，重新执行 `docker-compose build backend`。
  2. 若仍失败，手动下载 `dependency-check-9.0.9-release.zip`，放入 `backend/resources/`，并修改 Dockerfile 使用本地包。
  3. 如需最新版本，可参考 `手动安装Dependency-Check.md`。
- **验证**：进入容器执行 `/opt/dependency-check/dependency-check/bin/dependency-check.sh --version`。

### 2.2 npm 安装缓慢

- **现象**：前端镜像构建超过 15 分钟。
- **解决**：设置 `NPM_CONFIG_REGISTRY=https://registry.npmmirror.com` 或在 Dockerfile 中写入 `npm config set registry`。

### 2.3 容器启动后立即退出

- **现象**：`docker-compose ps` 显示 backend/exited。
- **原因**：环境变量缺失或端口冲突。
- **解决步骤**：
  1. 查看日志 `docker-compose logs --tail=200 backend`。
  2. 检查 `docker-compose.yml` 与 `.env` 是否一致，确认 Postgres 连接串正确。
- **验证**：访问 `http://<服务器>:5000/api/health` 返回 `{ "status": "healthy" }`。

## 3. 扫描工具相关

### 3.1 SCA 返回 0 结果

- **现象**：后台日志提示 `Dependency-Check not installed` 或 `npm audit发现 0 个漏洞`。
- **原因**：工具缺失/网络异常/项目中无依赖文件。
- **解决方案**：
  1. 确认 Docker 构建成功安装工具；若未安装，参考“手动安装 Dependency-Check”。
  2. Apple 项目类型中添加 `requirements.txt`、`package.json` 等文件。
- **验证**：重新发起 SCA，检查任务详情是否出现漏洞列表。

### 3.2 容器扫描返回 Mock 数据

- **现象**：结果中提示“未配置镜像名称”或“Trivy 检查失败”。
- **原因**：JSON 配置缺失 `image_name`，或容器内未安装 Trivy。
- **解决步骤**：
  1. 在扫描配置中填写 `{ "image_name": "your-image:tag" }`。
  2. 登录 backend 容器执行 `trivy --version`；若缺失，按 Trivy 官方文档安装。
- **验证**：重新扫描，确保结果中列出 CVE。

## 4. OpenRASP 集成

### 4.1 RaspInstall.jar 报 appsecret 长度错误

- **现象**：`appsecret must have 43~45 characters`。
- **原因**：后台提供的 app_secret 长度不足。
- **解决**：改用手工集成，拷贝 `rasp.jar`、`rasp-engine.jar`，手动配置 `cloud.app_secret`。

### 4.2 Agent 未在后台显示

- **现象**：OpenRASP “主机管理” 中无主机；`rasp/logs` 不存在。
- **解决步骤**：
  1. 确认 `MAVEN_OPTS` 注入成功（日志应有 `[OpenRASP] Engine Initialized`）。
  2. 在 `openrasp.yml` 中确保 `cloud.enable` 顶格、`cloud.backend_url` 指向正确地址。
  3. 访问 `http://localhost:9988/api/chat-history/test-rasp-file?filename=/etc/passwd` 触发攻击事件。
- **验证**：后台出现主机记录，攻击事件有日志。

### 4.3 YAML 解析错误

- **现象**：启动日志报 `while parsing a block mapping ... expected <block end>`。
- **原因**：`cloud.*` 行缩进不正确或多余空格。
- **解决步骤**：使用脚本 `检查OpenRASP配置结构.md` 中的 Python 代码修复缩进。
- **验证**：再次启动，错误消失。

## 5. 数据库相关

### 5.1 MySQL 连接失败（Access Denied）

- **现象**：`Access denied for user 'root'@'localhost'`。
- **原因**：MySQL 8 默认 `caching_sha2_password`、应用使用 `mysql_native_password`；或数据库未创建。
- **解决步骤**：参见 `彻底修复MySQL连接问题.md`，重建 root 用户并创建数据库。
- **验证**：`mysql -h 172.20.0.2 -uroot -p123456 -e "SHOW DATABASES;"`

### 5.2 Unknown database 'chatbotai_db'

- **现象**：Spring Boot 启动时报错。
- **解决**：执行 `CREATE DATABASE chatbotai_db`（见上文），并在 `application.properties` 修改为容器 IP。

## 6. 前端与认证问题

### 6.1 登录后跳回登录页

- **现象**：成功登录后立即跳转。
- **原因**：localStorage 旧 Token / JWT 过期 / `SECRET_KEY` 变化。
- **解决**：清空浏览器缓存、重新登录；若后端更新需重启容器。

### 6.2 上传状态不更新

- **现象**：弹窗仍显示“未上传”。
- **原因**：前端旧版本未监听上传结果。
- **解决**：已在最新版本修复；临时方案刷新页面或查看 `backend/uploaded_files/`。

## 7. CI/CD 集成问题

### 7.1 GitHub Actions 调用失败

- **现象**：API 返回 401 或 404。
- **原因**：Token 无效，或 URL 拼写错误。
- **解决**：确保使用 `/api/scans`，并在 Secrets 中存储 JWT；必要时添加重试。

## 8. 记录与升级

- 所有排障步骤应记录在对应 Markdown 中，便于知识积累。
- 升级前执行备份；升级后验证关键流程（登录、扫描、RASP 事件）。


