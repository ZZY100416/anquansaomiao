# Docker Compose超时问题解决方案

## 问题描述

启动前端容器时出现超时错误：
```
ERROR: for uss-frontend  UnixHTTPConnectionPool(host='localhost', port=None): Read timed out. (read timeout=60)
```

## 原因

前端容器启动时，`npm install` 需要下载大量依赖包，在较慢的网络环境下可能超过60秒超时限制。

## 解决方案

### 方案1: 增加超时时间（推荐）

在Ubuntu上执行：

```bash
# 设置环境变量
export COMPOSE_HTTP_TIMEOUT=300

# 然后重新启动
docker-compose up -d
```

或者永久设置：

```bash
# 添加到 ~/.bashrc
echo 'export COMPOSE_HTTP_TIMEOUT=300' >> ~/.bashrc
source ~/.bashrc
```

### 方案2: 分步启动服务

```bash
# 先启动其他服务
docker-compose up -d postgres redis backend

# 等待后端启动完成
sleep 30

# 再启动前端（单独启动，更容易看到进度）
docker-compose up -d frontend

# 或者在前台启动，查看详细日志
docker-compose up frontend
```

### 方案3: 优化前端Dockerfile

使用缓存优化npm安装：

```dockerfile
# 先只复制package.json，利用Docker缓存
COPY package*.json ./
RUN npm install --prefer-offline --no-audit

# 再复制其他文件
COPY . .
```

### 方案4: 使用国内npm镜像（如果在中国）

```bash
# 在Ubuntu上，先手动安装依赖
cd ~/projects/anquansaomiao/frontend

# 设置npm镜像
npm config set registry https://registry.npmmirror.com

# 安装依赖
npm install

# 然后启动服务
cd ..
docker-compose up -d
```

## 快速解决（立即执行）

在Ubuntu上执行：

```bash
# 1. 设置超时时间
export COMPOSE_HTTP_TIMEOUT=300

# 2. 停止所有服务
docker-compose down

# 3. 重新启动
docker-compose up -d

# 4. 查看日志（确认前端正在安装依赖）
docker-compose logs -f frontend
```

## 验证

```bash
# 查看所有服务状态
docker-compose ps

# 应该看到所有服务都是 "Up" 状态
# 如果前端还在启动中，等待几分钟

# 查看前端日志
docker-compose logs frontend

# 如果看到 "webpack compiled" 或类似信息，说明启动成功
```

## 如果仍然超时

可以尝试：

1. **检查网络连接**
   ```bash
   ping github.com
   ping registry.npmjs.org
   ```

2. **手动构建前端镜像**
   ```bash
   docker-compose build frontend
   docker-compose up -d frontend
   ```

3. **使用生产构建模式**（更快）
   ```bash
   # 修改frontend/Dockerfile，使用生产构建
   # 将 CMD ["npm", "start"] 改为
   # RUN npm run build
   # CMD ["npx", "serve", "-s", "build", "-l", "3000"]
   ```

