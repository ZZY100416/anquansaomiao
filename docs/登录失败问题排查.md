# 登录失败问题排查指南

## 问题现象

前端登录页面显示"登录失败"，无法使用 admin/admin123 登录。

## 可能原因

1. **数据库未初始化** - admin用户不存在
2. **API连接问题** - 前端无法连接到后端
3. **密码验证问题** - 密码哈希不匹配

## 排查步骤

### 步骤1: 检查数据库是否已初始化

在Ubuntu上执行：

```bash
# 进入backend容器
docker-compose exec backend bash

# 在容器内检查admin用户是否存在
python -c "
from app import app, db
from app.models.user import User
with app.app_context():
    admin = User.query.filter_by(username='admin').first()
    if admin:
        print('✓ Admin用户存在')
        print(f'  用户名: {admin.username}')
        print(f'  邮箱: {admin.email}')
        print(f'  角色: {admin.role}')
    else:
        print('✗ Admin用户不存在，需要初始化数据库')
"

# 退出容器
exit
```

### 步骤2: 如果用户不存在，初始化数据库

```bash
# 初始化数据库
docker-compose exec backend python init_db.py
```

预期输出：
```
✓ 默认管理员账户创建成功
  用户名: admin
  密码: admin123
✓ 数据库初始化完成
```

### 步骤3: 验证后端API是否正常

```bash
# 测试登录API
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

预期响应：
```json
{
  "access_token": "...",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  }
}
```

### 步骤4: 检查前端API连接

如果前端通过IP访问（如 `192.168.203.141:3000`），需要修改API URL。

#### 方法1: 修改docker-compose.yml（推荐）

```yaml
frontend:
  environment:
    - REACT_APP_API_URL=http://192.168.203.141:5000/api
```

然后重启前端：
```bash
docker-compose up -d --build frontend
```

#### 方法2: 在浏览器中检查网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network（网络）标签
3. 尝试登录
4. 查看 `/api/auth/login` 请求：
   - 如果显示 `Failed to fetch` 或 `Network Error`，说明API连接失败
   - 如果返回401，说明用户名或密码错误
   - 如果返回500，说明后端错误

### 步骤5: 检查后端日志

```bash
# 查看后端实时日志
docker-compose logs -f backend

# 尝试登录，观察日志输出
```

## 快速修复命令

```bash
# 1. 检查容器状态
docker-compose ps

# 2. 检查后端日志
docker-compose logs backend | tail -20

# 3. 初始化数据库（如果未初始化）
docker-compose exec backend python init_db.py

# 4. 测试API
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 5. 如果API正常但前端无法连接，检查前端API URL配置
# 查看前端环境变量
docker-compose exec frontend env | grep REACT_APP_API_URL

# 6. 重启服务
docker-compose restart backend frontend
```

## 常见错误及解决方案

### 错误1: "用户名或密码错误" (401)

**原因**: 数据库未初始化或密码错误

**解决**:
```bash
docker-compose exec backend python init_db.py
```

### 错误2: "Network Error" 或 "Failed to fetch"

**原因**: 前端无法连接到后端API

**解决**:
1. 检查后端是否运行: `docker-compose ps`
2. 检查端口是否开放: `curl http://localhost:5000/api/health`
3. 如果通过IP访问，修改API URL（见步骤4）

### 错误3: "Internal Server Error" (500)

**原因**: 后端代码错误或数据库连接失败

**解决**:
```bash
# 查看详细错误日志
docker-compose logs backend

# 检查数据库连接
docker-compose exec backend python -c "from app import app, db; print('DB OK')"
```

## 验证清单

- [ ] Backend容器状态为 `Up`
- [ ] Frontend容器状态为 `Up`
- [ ] 数据库已初始化（admin用户存在）
- [ ] `curl http://localhost:5000/api/health` 返回正常
- [ ] `curl` 测试登录API成功
- [ ] 浏览器开发者工具中API请求正常
- [ ] 前端能正确显示错误信息

## 如果问题仍然存在

1. **收集信息**:
   ```bash
   # 容器状态
   docker-compose ps
   
   # 后端日志
   docker-compose logs backend > backend.log
   
   # 前端日志
   docker-compose logs frontend > frontend.log
   ```

2. **检查浏览器控制台**:
   - 打开开发者工具（F12）
   - 查看Console（控制台）标签的错误信息
   - 查看Network（网络）标签的API请求详情

3. **手动测试API**:
   ```bash
   # 健康检查
   curl http://localhost:5000/api/health
   
   # 登录测试
   curl -X POST http://localhost:5000/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"admin123"}'
   ```

