# 排查容器扫描失败问题

## 问题现象
- 扫描任务显示"失败"
- 日志中没有 `[Container]` 标记的输出
- 查看结果时没有详细信息

## 排查步骤

### 1. 检查后端容器是否已重启（加载最新代码）

```bash
# 在Ubuntu上执行
cd ~/projects/anquansaomiao

# 重启后端容器
docker-compose restart backend

# 等待几秒让容器完全启动
sleep 5

# 检查容器状态
docker-compose ps backend
```

### 2. 查看完整的后端日志（不筛选）

```bash
# 查看最近100行日志
docker-compose logs --tail=100 backend

# 或者查看所有日志
docker-compose logs backend | tail -100
```

### 3. 查看扫描任务相关的日志

```bash
# 查看所有扫描相关的日志
docker-compose logs --tail=200 backend | grep -E "\[Scan\]|\[Container\]|扫描|scan"

# 查看错误日志
docker-compose logs --tail=200 backend | grep -i error
```

### 4. 检查扫描任务是否真正执行

```bash
# 查看扫描服务启动日志
docker-compose logs --tail=200 backend | grep -E "开始执行扫描|ScannerService|scan_id"
```

### 5. 手动测试容器扫描器

```bash
# 进入后端容器
docker-compose exec backend bash

# 在容器内测试Trivy
trivy --version

# 如果Trivy未安装，尝试扫描一个镜像
trivy image nginx:latest
```

### 6. 检查代码是否已更新

```bash
# 进入容器检查代码文件
docker-compose exec backend bash
cat /app/app/scanners/container_scanner.py | head -20

# 应该能看到 `import sys` 和 `print(f"[Container]` 等代码
```

### 7. 查看Python异常日志

```bash
# 查看是否有Python异常
docker-compose logs --tail=200 backend | grep -i "traceback\|exception\|error"
```

## 可能的原因

1. **代码未更新**：容器内的代码还是旧版本
2. **扫描任务未执行**：后台线程没有启动
3. **异常被静默捕获**：异常被捕获但没有输出日志
4. **Trivy未安装**：扫描器调用失败但没有日志输出
5. **配置错误**：扫描配置格式错误导致解析失败

## 快速修复

### 方案1：强制重启并查看日志

```bash
cd ~/projects/anquansaomiao
docker-compose down backend
docker-compose up -d backend
sleep 10
docker-compose logs --tail=50 backend
```

### 方案2：检查扫描任务创建

在前端创建扫描任务时，确保配置格式正确：
```json
{"image_name": "nginx:latest"}
```

### 方案3：验证代码已更新

```bash
# 检查容器内的代码文件修改时间
docker-compose exec backend ls -la /app/app/scanners/container_scanner.py

# 检查文件内容
docker-compose exec backend head -20 /app/app/scanners/container_scanner.py
```

