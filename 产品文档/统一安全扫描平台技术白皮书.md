# 统一安全扫描平台技术白皮书

## 1. 引言

- 随着 DevSecOps 推进，安全扫描需从战术工具转向平台化能力。我们构建的 USS 平台以开源组件为核心，强调落地成本低、可观测强、运行时联动。
- 本白皮书旨在为技术负责人与架构师提供深入的架构说明、技术选型理由、性能与安全策略。

## 2. 总体架构

### 2.1 逻辑架构

```
┌──────────────────────────────────────────────────────────┐
│ 前端 Portal (React + Ant Design)                        │
│  - 身份认证 / 仪表盘 / 项目管理 / 扫描任务 / RASP 事件 │
└───────────────────────▲──────────────────────────────────┘
                        │RESTful API
┌───────────────────────┴──────────────────────────────────┐
│ 后端服务 (Flask)                                         │
│  - Auth & JWT                                             │
│  - Projects/Scans/Reports API                             │
│  - Scanner Service（SAST/SCA/容器/RASP）                  │
│  - ThreadPool Executor                                    │
│  - SQLAlchemy ORM                                         │
└───────────────▲───────────────────────┬──────────────────┘
                │                       │
      PostgreSQL (业务库)          扫描工具子进程
                                     ・Semgrep
                                     ・Dependency-Check / pip-audit / npm audit
                                     ・Trivy / Hadolint
                                     ・OpenRASP REST API
```

### 2.2 部署架构

- Docker Compose：`frontend`、`backend`、`postgres`、`redis`
- Volume：`scan_results/`、`uploaded_files/`
- 网络：内部 bridge；前端可通过 Nginx 暴露 HTTPS
- 监控：后续可引入 Prometheus + Grafana（目前提供日志导出）

## 3. 技术选型

| 模块 | 选型 | 选型理由 |
| ---- | ---- | -------- |
| 前端 | React + Ant Design + Vite | 开发效率高、组件丰富、适合后台管理系统 |
| 后端 | Python Flask | 轻量、生态丰富，便于整合 CLI 扫描工具 |
| 数据库 | PostgreSQL | 支持 JSON 字段、稳健；与 SQLAlchemy 兼容良好 |
| 队列 | ThreadPool（内置） + Redis（可选） | 任务量中等，先用轻量线程池；如要扩容，可迁移 Celery |
| SAST | Semgrep | 规则覆盖广、书写灵活、开源免费 |
| SCA | Dependency-Check、pip-audit、npm audit | 覆盖 Java、Python、Node；支持离线缓存 |
| 容器 | Trivy、Hadolint | 社区接受度高、更新快 |
| RASP | OpenRASP | 开源 RASP，支持手工集成与 API 调用 |

## 4. 核心流程

### 4.1 登录与鉴权

1. 用户注册登录 → 获取 JWT（Access Token）
2. 前端存储 Token 于 `localStorage`
3. API 端使用 `flask-jwt-extended` 校验

### 4.2 扫描任务执行

1. 前端发起 POST `/api/scans`
2. 后端写入数据库，状态 = `queued`
3. ThreadPool 拉取任务 → 根据 `scan_type` 调度具体 Scanner
4. Scanner 调用 CLI（`subprocess.run`）或 REST（OpenRASP）
5. 结果解析写入 `scan_results` 表，状态更新为 `completed/failed`

### 4.3 RASP 事件同步

1. 每次请求 `/api/rasp/events` 时初始化 `RASPScanner`
2. 自动登录（用户名/密码）获取 `RASP_AUTH_ID` Cookie
3. 向 `/v1/api/log/attack/search` POST 请求
4. 结果转换为平台标准字段返回

## 5. 安全策略

| 层级 | 措施 |
| ---- | ---- |
| 身份认证 | JWT + HTTPS（推荐配合 Nginx） |
| 数据安全 | PostgreSQL 定期备份；扫描结果与上传文件使用受控目录 |
| 工具沙箱 | 扫描工具运行于独立容器，避免对宿主影响 |
| RASP 集成 | app_id/app_secret 仅保存在安全配置文件，后端调用时不落库 |
| 日志审计 | 后端打印结构化日志；Docker 支持 `json-file` 或 Syslog |

## 6. 性能与扩展性

- 当前 ThreadPool 默认 4 个 worker，可根据 CPU 调整。
- 扫描任务耗时取决于工具（Semgrep 约 1-3 分钟，Trivy 随镜像大小而定）。
- 当任务量增大时，可迁移至 Celery + RabbitMQ 架构，Docker Compose 已预留 Redis 服务。

## 7. 运维接口

- REST API：`/api/projects`、`/api/scans`、`/api/rasp/events`
- CLI：`docker-compose logs [service]`、`docker exec -it uss-backend /bin/bash`
- GitHub Actions 示例脚本已在 `.github/workflows/` 内。

## 8. 风险与缓解

| 风险 | 影响 | 缓解策略 |
| ---- | ---- | -------- |
| 扫描工具下载失败 | 构建中断 | Dockerfile 加重试 & 备用版本；手册提供手工安装脚本 |
| RaspInstall 参数不满足 | Agent 无法注册 | 文档中提供手工集成流程及 YAML 配置模板 |
| 数据库访问异常 | 任务失败 | MySQL/Postgres 排障手册；重试机制；健康检查 |
| 大型项目扫描耗时长 | CI 阻塞 | 支持异步执行 + 后台查看结果 + 结果分页 |

## 9. 未来规划

- 扫描结果与运行时事件打通，形成统一风险画像。
- 引入消息通知（邮件、IM）、Webhook。
- 建立规则管理平台，支持自定义 Semgrep/Pipeline 规则。
- SaaS 化部署支持，提供多租户隔离。


