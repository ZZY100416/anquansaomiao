# 统一安全扫描平台安装与升级手册

> 本手册适用于在 Ubuntu 22.04 环境下安装、升级和运维“智控安防统一安全扫描平台”（USS），同时涵盖 OpenRASP Agent 的手工集成步骤与常见故障处理。

## 1. 前置条件

| 组件 | 版本建议 | 安装检查 |
| ---- | -------- | -------- |
| Docker Engine | ≥ 24.0 | `docker version`
| Docker Compose | v2 | `docker compose version`
| Git | 最新 | `git --version`
| Node.js | 18.x | `node -v`
| Python | 3.11 | `python3 --version`
| Java | OpenJDK 17+ | `java -version`
| Maven | 3.9.x | `mvn -version`

## 2. 代码获取

```bash
git clone https://github.com/xxx/anquannchanpin.git
cd anquannchanpin
```

如需从 Windows 传输，可先 push 至 GitHub，再在 Ubuntu 上 clone；也可使用 `scp` 或共享文件夹。

## 3. Docker Compose 部署

```bash
docker-compose up -d --build
# 首次启动时间约 5-10 分钟（依赖下载）
```

### 3.1 常见构建问题

- **Dependency-Check 下载失败**：Dockerfile 已提供重试和备用版本；如仍失败，可手工下载离线包并替换。
- **npm 安装缓慢**：提前设置 `NPM_REGISTRY=https://registry.npmmirror.com`。
- **容器启动后立即退出**：使用 `docker-compose logs --tail=200 backend` 检查错误；确认端口/权限无冲突。

### 3.2 服务说明

| 服务 | 端口 | 说明 | 数据卷 |
| ---- | ---- | ---- | ------ |
| frontend | 3000 | React 前端 | 无 |
| backend | 5000 | Flask API | `scan_results/`、`uploaded_files/` |
| postgres | 5432 | 业务数据库 | `postgres_data` |
| redis (可选) | 6379 | 任务队列预留 | `redis_data` |

## 4. OpenRASP Agent 集成

由于 RaspInstall.jar 对 appsecret 长度有 43-45 字符限制，平台提供的密钥无法直接通过该工具，推荐使用手动方式。

### 4.1 环境准备

```bash
# OpenRASP 安装包目录
~/openrasp/rasp-2023-03-31

# Spring Boot 应用目录
~/projects/bailianyingyong/chatbotAi
```

### 4.2 手工部署

```bash
cd ~/projects/bailianyingyong/chatbotAi
mkdir -p rasp/conf rasp/logs rasp/plugins
cp ~/openrasp/rasp-2023-03-31/rasp/rasp.jar rasp/
cp ~/openrasp/rasp-2023-03-31/rasp/rasp-engine.jar rasp/
cp ~/openrasp/rasp-2023-03-31/rasp/conf/openrasp.yml rasp/conf/
```

编辑 `rasp/conf/openrasp.yml`：

```yaml
cloud.enable: true
cloud.backend_url: http://192.168.203.141:8086
cloud.app_id: 0c91b98f2aa79983228f10fc37725da726bd31d6
cloud.app_secret: 03HUqrDFqauBGqsHhkp@yxyMc871U83NuIGxQBoStIU
```

启动应用并注入 Agent：

```bash
export MAVEN_OPTS="-javaagent:/home/enen/projects/bailianyingyong/chatbotAi/rasp/rasp.jar \
--add-opens=java.base/jdk.internal.loader=ALL-UNNAMED \
--add-opens=java.base/java.net=ALL-UNNAMED \
--add-opens=java.base/java.lang=ALL-UNNAMED \
--add-opens=java.base/java.util=ALL-UNNAMED"
mvn spring-boot:run
```

### 4.3 验证与排障

- 观察控制台日志出现 `[OpenRASP] Engine Initialized`。  
- 登录 OpenRASP 后台（`http://192.168.203.141:8086`），在“主机管理”中出现主机 `enen`。  
- 若后台无日志：
  1. 确认 `rasp/logs` 是否生成；默认不输出，可在 YAML 中开启文件日志。  
  2. 使用 `curl http://localhost:9988/api/chat-history/test-rasp-file?filename=/etc/passwd` 触发攻击事件。  
  3. 确保 app_secret 行未被注释、没有额外空格。

## 5. MySQL 补充配置（适用于示例项目）

```bash
docker exec -i rasp-mysql mysql -u root -p123456 <<'EOF'
CREATE DATABASE IF NOT EXISTS chatbotai_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
DROP USER IF EXISTS 'root'@'localhost';
DROP USER IF EXISTS 'root'@'%';
CREATE USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '123456';
CREATE USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY '123456';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
EOF
```

项目配置：

```properties
spring.datasource.url=jdbc:mysql://172.20.0.2:3306/chatbotai_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&useAffectedRows=true
spring.datasource.username=root
spring.datasource.password=123456
```

## 6. 升级流程

1. **更新代码**：`git pull`
2. **重新构建**：`docker-compose up -d --build`
3. **数据库迁移**：视情况运行 Alembic 或 SQL 脚本
4. **验证**：登录前端，执行一次扫描、查看 RASP 事件

## 7. 备份与回滚

- 数据库备份：`pg_dump -U scanner security_scanner > backup.sql`
- 文件卷备份：压缩 `scan_results/` 与 `uploaded_files/`
- 回滚：停止服务 → 切换 Git tag → 恢复备份 → 重新部署

## 8. 附录

### 8.1 常用命令

```bash
docker-compose ps
docker-compose logs --tail=200 backend
docker exec -it uss-backend /bin/bash
ls backend/scan_results/
```

### 8.2 日志位置

- 后端应用日志：`backend/logs/app.log`
- 扫描结果：`backend/scan_results/scan_{id}/`
- RASP Agent：默认未启用，可在 `openrasp.yml` 中配置 `log_path`


