# 修复422错误 - JWT Token验证失败

## 问题分析

所有API请求返回422错误，这是JWT token验证失败导致的。

## 已实施的修复

### 1. 添加JWT错误处理器

已在 `backend/app/__init__.py` 中添加详细的JWT错误处理，可以显示具体的错误信息。

## 立即排查步骤

### 步骤1: 重新登录获取新Token

**最可能的原因**：Token格式错误或已失效

1. **在浏览器中退出登录**
   - 清除localStorage中的token
   - 或打开F12 -> Application -> Local Storage -> 删除token

2. **重新登录**
   - 访问：`http://192.168.203.141:3000/login`
   - 使用 admin/admin123 登录
   - 确保登录成功

### 步骤2: 检查Token是否正确发送

在浏览器中：
1. 按 F12 打开开发者工具
2. 切换到 Network 标签
3. 尝试创建项目
4. 查看 `/api/projects` 请求的 **Headers**：
   - 应该看到 `Authorization: Bearer <token>`
   - 如果看不到，说明token没有正确发送

### 步骤3: 查看详细错误信息

```bash
# 在Ubuntu上查看后端日志（现在会显示详细错误）
docker-compose logs -f backend
```

然后尝试创建项目，应该会看到详细的错误信息，例如：
- "无效的Token: ..."
- "缺少Token: ..."
- "Token已过期"

### 步骤4: 测试Token是否有效

```bash
# 在浏览器F12 -> Application -> Local Storage -> 复制token值
# 然后执行（替换YOUR_TOKEN）

TOKEN="你的token值"

# 测试API
curl -X GET http://localhost:5000/api/projects \
  -H "Authorization: Bearer $TOKEN" \
  -v
```

## 常见问题及解决方案

### 问题1: Token未正确保存

**症状**：Network标签中看不到Authorization头

**解决**：
```javascript
// 检查前端是否正确保存token
// 在浏览器Console中执行：
localStorage.getItem('token')
```

如果返回null，说明token没有保存，需要重新登录。

### 问题2: Token格式错误

**症状**：后端日志显示"无效的Token"

**解决**：
- 重新登录获取新token
- 确保前端正确发送token格式：`Bearer <token>`

### 问题3: Token过期

**症状**：后端日志显示"Token已过期"

**解决**：
- 虽然设置了`JWT_ACCESS_TOKEN_EXPIRES = False`（不过期）
- 但如果还有问题，重新登录

### 问题4: CORS预检成功但请求失败

**症状**：OPTIONS请求200，但实际请求422

**原因**：这是正常的，OPTIONS是预检请求，不验证token。实际请求需要验证token。

## 快速修复命令

```bash
# 1. 重启后端（应用新的错误处理）
docker-compose restart backend

# 2. 查看日志（现在会显示详细错误）
docker-compose logs -f backend

# 3. 在浏览器中：
#    - 清除localStorage
#    - 重新登录
#    - 尝试创建项目
```

## 验证修复

1. **重新登录**后，查看浏览器Network标签
2. 创建项目时，查看：
   - 请求头是否有 `Authorization: Bearer ...`
   - 响应状态码（应该是200或201，不是422）
3. 如果还有422，查看后端日志的详细错误信息

## 如果还是不行

请提供：
1. **后端日志**：`docker-compose logs --tail=20 backend`（现在会显示详细错误）
2. **浏览器Network标签**：查看 `/api/projects` 请求的Headers和Response
3. **浏览器Console**：是否有JavaScript错误

